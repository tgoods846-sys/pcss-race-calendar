name: Post Social Images

on:
  workflow_dispatch:
    inputs:
      folder:
        description: 'Folder name in output/social/ (e.g., "This Weekend in PC Ski Racing Feb 20-22")'
        required: true
        type: string
      content_type:
        description: 'Content type'
        required: true
        type: choice
        options:
          - pre_race
          - race_day
          - weekly_preview
          - weekend_preview
          - monthly_calendar
      platforms:
        description: 'Target platforms'
        required: true
        type: choice
        default: both
        options:
          - both
          - facebook-only
          - instagram-only
      dry_run:
        description: 'Dry run (preview only, no actual posting)'
        required: false
        type: boolean
        default: false

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Regenerate images
        run: python3 -m social.generate --type ${{ inputs.content_type }}

      - name: Build poster flags
        id: flags
        run: |
          FLAGS=""
          if [ "${{ inputs.platforms }}" = "facebook-only" ]; then
            FLAGS="$FLAGS --facebook-only"
          elif [ "${{ inputs.platforms }}" = "instagram-only" ]; then
            FLAGS="$FLAGS --instagram-only"
          fi
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi
          FLAGS="$FLAGS --type ${{ inputs.content_type }}"
          echo "flags=$FLAGS" >> "$GITHUB_OUTPUT"

      - name: Post to social media
        env:
          META_PAGE_ACCESS_TOKEN: ${{ secrets.META_PAGE_ACCESS_TOKEN }}
          META_PAGE_ID: ${{ secrets.META_PAGE_ID }}
          META_IG_USER_ID: ${{ secrets.META_IG_USER_ID }}
        run: python3 -m social.poster "${{ inputs.folder }}" ${{ steps.flags.outputs.flags }}
